{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <a href="/" class="btn btn-secondary">&larr; Back</a>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Today's Conditions</h5>
                <div class="row">
                    <div class="col-md-4">
                        <p class="mb-1 text-muted">Location</p>
                        <p>{{ location.lat }}, {{ location.lon }}</p>
                        <p class="mb-1 text-muted">Time</p>
                        <p>{{ location.time.split('T')[1][:5] if 'T' in location.time else location.time }}</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1 text-muted">Weather</p>
                        <p class="mb-0">Cloud Cover:
                            <span
                                class="{{ 'text-success' if weather.cloud_cover < 20 else 'text-warning' if weather.cloud_cover < 50 else 'text-danger' }}">
                                {{ weather.cloud_cover if weather.cloud_cover is not none else 'N/A' }}%
                            </span>
                        </p>
                        <p class="mb-0">Transparency: {{ weather.transparency }}</p>
                        <p class="mb-0">Dew Point: {{ weather.dew_point }}째C</p>
                    </div>
                    <div class="col-md-4">
                        <p class="mb-1 text-muted">Moon</p>
                        <p class="mb-0">{{ moon.illumination }}% Illuminated</p>
                        {% if moon.is_up %}
                        <p class="text-warning mb-0"><i class="bi bi-moon-stars"></i> Up (Alt: {{ moon.altitude }}째)</p>
                        {% else %}
                        <p class="text-secondary mb-0">Below Horizon</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="mb-3">Recommended Targets</h3>

<div class="row">
    {% for obj in objects %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 border-0 shadow-sm" style="background: rgba(30, 30, 45, 0.8);">
            {% if obj.image %}
            <div style="position: relative;">
                <img src="{{ obj.image }}" class="card-img-top" alt="{{ obj.name }}"
                    style="height: 200px; object-fit: cover;">
                <div style="position: absolute; top: 10px; right: 10px;">
                    <span
                        class="badge bg-{{ 'success' if obj.score > 70 else 'warning' if obj.score > 40 else 'danger' }}">
                        {{ obj.score }}
                    </span>
                </div>
                {% if obj.fov_match %}
                <div style="position: absolute; bottom: 10px; left: 10px;">
                    <span class="badge {{ 'bg-success' if obj.fov_match == 'Fits in FOV' else 'bg-danger' }}">
                        {{ obj.fov_match }}
                    </span>
                </div>
                {% endif %}
            </div>
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ obj.name }} <span class="text-muted d-block fs-6">{{ obj.id }} &bull; {{
                        obj.type }}</span></h5>

                <div class="row g-2 mb-3 mt-2 font-monospace" style="font-size: 0.85rem;">
                    <div class="col-6">
                        <span class="text-muted">Mag:</span> {{ obj.mag }}
                    </div>
                    <div class="col-6">
                        <span class="text-muted">Size:</span> {{ obj.size }}'
                    </div>
                    <div class="col-6">
                        <span class="text-muted">Alt:</span> {{ obj.altitude }}째
                    </div>
                    <div class="col-6">
                        <span class="text-muted">Az:</span> {{ obj.azimuth }}째
                    </div>
                    <div class="col-6">
                        <span class="text-muted">Rise:</span> {{ obj.rise_time }}
                    </div>
                    <div class="col-6">
                        <span class="text-muted">Set:</span> {{ obj.set_time }}
                    </div>
                    <div class="col-12">
                        <span class="text-muted">Transit:</span> {{ obj.transit_time }} <span
                            class="text-muted">(Highest)</span>
                    </div>
                </div>

                <div class="alert alert-dark py-1 px-2 mb-2" style="font-size: 0.8rem;">
                    <strong>Best Window:</strong> {{ obj.best_window }}
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">Airmass: {{ obj.airmass }}</small>
                    <button class="btn btn-sm btn-outline-info" data-id="{{ obj.id }}"
                        data-ra="{{ obj.ra_deg|default(0) }}" data-dec="{{ obj.dec_deg|default(0) }}"
                        onclick="showSkyMap(this.dataset.id, this.dataset.ra, this.dataset.dec)">
                        Show in Sky
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Sky Map Modal -->
<div class="modal fade" id="skyMapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content text-bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="skyMapTitle">Sky Map</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="aladin-lite-div" style="width: 100%; height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add jQuery (Required for Aladin Lite v2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css" />
<script type="text/javascript" src="https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js"
    charset="utf-8"></script>

<script>
    let aladin;
    let currentRa, currentDec, currentId;

    function showSkyMap(id, raStr, decStr) {
        currentId = id;
        // Parse defaults if "0"
        currentRa = parseFloat(raStr);
        currentDec = parseFloat(decStr);

        const modalEl = document.getElementById('skyMapModal');
        const modal = new bootstrap.Modal(modalEl);

        document.getElementById('skyMapTitle').innerText = 'Sky Map: ' + id;
        modal.show();
    }

    // Initialize Aladin ONLY when the modal is actually shown to the user
    // This prevents "width/height 0" bugs in canvas plotting
    document.getElementById('skyMapModal').addEventListener('shown.bs.modal', function () {
        if (!aladin) {
            console.log("Initializing Aladin...");
            aladin = A.aladin('#aladin-lite-div', {
                survey: "P/DSS2/color",
                fov: 1.5,
                target: currentId
            });
        }

        console.log("GoTo", currentRa, currentDec);
        aladin.gotoRaDec(currentRa, currentDec);

        // Clear previous markers
        aladin.removeLayers();

        // Add marker
        var marker = A.marker(currentRa, currentDec, { popupTitle: currentId });
        var layer = A.catalog();
        aladin.addCatalog(layer);
        layer.addSources([marker]);
    });
</script>
{% endblock %}